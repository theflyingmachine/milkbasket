{% include "register/header.html" %}

{# PROD Bundle #}
{#<script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>#}
{#<script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>#}

{#<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.min.js"></script>#}

{# Dev Bundle #}
<script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.min.js"></script>

<script
 src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"></script>

<style>
    .info-row {
        background-color: #F8D79B !important;
    }
</style>

{% block content %}

  <div class="row bd-highlight">
    <div class="col-12 col-md-6 mr-auto p-2 bd-highlight">
      <button type="button" class="btn mt-2 mr-2 btn-primary" data-toggle="modal"
              data-target="#exampleModal1"
              data-whatever="@fat"><i class="fas fa-dollar-sign"></i> | Add Expense
      </button>
      <button type="button" class="btn mt-2  btn-primary" data-toggle="modal"
              data-target="#addIncomeModal"
              data-whatever="@fat"><i class="fas fa-rupee-sign"></i> | Add Income
      </button>
    </div>
    <div class="justify-content-end inline p-2 bd-highlight">
      <form name="view_select_record" action="{% url 'view_select_record' %}"
            method="post">{% csrf_token %}
        <label for="myDate" class="col-form-label">Select Report:</label>
        <input type="hidden" name="nav-type" value="account" id="nav">
        <input class="inline" type="month" name="register_month" id="mydate"
               value="{% now 'Y-m' %}">
        <button type="submit" class="btn btn-primary">GO</button>
      </form>
    </div>
  </div>
  <h5 class="p-0 m-0 text-center">Income and Expenses - {{ month_year }}</h5>
  <hr class="mt-1">


  <div id="report"></div>

  {# React Report Starts #}

  <script type="text/babel">

    function formatDate(log_date) {
      return new Date(log_date).toLocaleDateString('en-US', {
        day: '2-digit',
        month: 'short'
      });
    }

    class IncomeExpense extends React.Component {
      render() {
        return (
          <div>
            <h3 className="pt-2 mt-2 text-center">{this.props.title}</h3>
            <table className="table mb-5 table-sm table-striped">
              <thead>
              <tr className=" bg-info text-white">
                <th className="p-1 col-1" scope="col">#</th>
                <th className="p-1 col-5" scope="col">Description</th>
                <th className="p-1 col-2" scope="col">Amount</th>
                <th className="p-1 col-2" scope="col">Date</th>
                <th className="p-1 col-2" scope="col">Action</th>
              </tr>
              </thead>
              <tbody>
              {this.props.entry.map((expense, index) => (
                <tr key={expense.id} className="">
                  <th className="py-2 col-1" scope="row">{index + 1}</th>
                  <td className="py-2 col-5">{expense.description}</td>
                  <td className="py-2 col-2">{parseFloat(expense.amount).toFixed(1)}</td>
                  <td className="py-2 col-2">{formatDate(expense.log_date)}</td>
                  <td className="py-2 col-2">
                    <button type="button" className="btn-sm btn-danger"
                            data-toggle="modal"
                            data-target="#exampleModal"
                            data-id="{{ expense.id }}"
                            data-desc="{{ expense.description }}"
                            data-cost="{{ expense.cost }}"
                            data-log_date="{{ expense.log_date }}"
                    >Delete
                    </button>
                  </td>
                </tr>
              ))}
              <tr className="info-row">
                <td colSpan="5" className="py-2 font-weight-bold"><i
                  className="fas fa-calculator text-info"></i> Total {this.props.title}:
                  Rs {this.props.entry.reduce((acc, expense) => acc + parseFloat(expense.amount), 0)}
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        );
      }
    }


    class PaidCustomers extends React.Component {
      render() {
        return (
          <div>
            <h3 className="pt-2 mt-2 text-center">{this.props.title}</h3>
            <table className="table mb-5 table-sm table-striped">
              <thead>
              <tr className="bg-info text-white">
                <th className="p-1 col-1" scope="col">#</th>
                <th className="p-1 col-5" scope="col">Name</th>
                <th className="p-1 col-3" scope="col">Adjusted Amount</th>
                <th className="p-1 col-3" scope="col">Paid Amount</th>
              </tr>
              </thead>
              <tbody>
              {this.props.entry.map((entry, index) => (
                <tr key={index}>
                  <th className="py-2  col-1" scope="row">{index + 1}</th>
                  <th className="py-2  col-5" scope="row"><a
                    href="#">{entry.name}</a>
                    {#href="{% url 'customer_profile'  entry.customer_id %}">{entry.name}</a>#}
                  </th>
                  {entry.balance_amount < 0 ?
                    <td
                      className="text-success col-3 font-weight-bold">{Math.abs(entry.balance_amount)}
                      &nbsp;(Adv)</td> :
                    entry.balance_amount > 0 ?
                      <td className="col-3">{entry.balance_amount}</td> :
                      <td className="col-3"></td>
                  }
                  <td className="py-2  col-3"><b>{entry.paid_amount}</b></td>

                </tr>

              ))}
              <tr className="info-row">
                <td colSpan="4" className="py-2 font-weight-bold"><i
                  className="fas fa-calculator text-info"></i> Total {this.props.title}:
                  Rs {this.props.entry.reduce((acc, paid) => acc + parseFloat(paid.paid_amount), 0)}
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        );
      }
    }

    class DueCustomers extends React.Component {
      render() {
        return (
          <div>
            <h3 className="pt-2 mt-2 text-center">{this.props.title}</h3>
            <table className="table mb-5 table-sm table-striped">
              <thead>
              <tr className="bg-info text-white">
                <th className="p-1 col-1" scope="col">#</th>
                <th className="p-1 col-3" scope="col">Name</th>
                <th className="p-1 col-2" scope="col">Total Due</th>
                <th className="p-1 col-2" scope="col">Due (till {this.props.previous_month_name})
                </th>
                <th className="p-1 col-4" scope="col">Action</th>
              </tr>
              </thead>
              <tbody>
              {this.props.entry.map((entry, index) => (
                <tr key={index}>
                  <th className="py-2 col-1" scope="row">{index + 1}</th>
                  <th className="py-2 col-3" scope="row"><a
                    href="#">{entry.name}</a>
                    {#href="{% url 'customer_profile'  entry.customer_id %}">{{ entry.customer__name }}</a>#}
                  </th>
                  <td className="py-2 col-2">{entry.due_amount}</td>
                  <td className="py-2 col-2">
                    {entry.due_prev_amount > 0 ?
                      <div>
                        <span className="font-weight-bold">{entry.due_prev_amount}</span> &nbsp;
                        <span className="text-info">{this.props.previous_month_name}</span>
                      </div> : ''}</td>
                  <td className="py-2 col-4">
                    <button type="button" className="btn-sm btn-primary my-1 p-0 p-lg-2 p-md-1"
                            data-toggle="modal"
                            data-target="#exampleModal2"
                            data-cid="{{ entry.customer_id }}"
                            data-cname="{{ entry.customer__name }}"
                            data-c_contact="{{ entry.customer__contact }}"
                            data-dueamount="{{ entry.payment_due }}"
                     {% if not entry.payment_due_prev or is_last_day_of_month or tenant.bill_till_date %}
                            data-prevdueamount="{{ entry.payment_due }}"
                            data-monthname="1"
                     {% else %}
                            data-prevdueamount="{{ entry.payment_due_prev }}"
                            data-monthname="0"
                     {% endif %}
                    >Make Payment
                    </button>
                  </td>
                </tr>
              ))}
              <tr className="info-row">
                <td colSpan="5" className="py-2 font-weight-bold"><i
                  className="fas fa-calculator text-info"></i> Total
                  Due :
                  Rs {this.props.entry.reduce((total, customer) => total + parseFloat(customer.due_amount), 0)}
                  &nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;
                  <i className="fas fa-calculator text-info"></i> Due
                  ({this.props.previous_month_name}):{this.props.entry.reduce((total, customer) => total + parseFloat(customer.due_prev_amount), 0)}
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        );
      }
    }


    class Accounts extends React.Component {

      constructor(props) {
        super(props);
        // this.findDateEntry = this.findDateEntry.bind(this);
        this.handler = this.handler.bind(this)

        this.state = {
          expenses: null,
          income: null,
          paid_customers: null,
          due_customers: null,
          previous_month_name: null,
          is_loading: true,
          is_error: false,

          ajax_loading: false,
        };
      }

      handler() {
        this.setState({
          someVar: 'some value'
        })
      }


      async componentDidMount() {
        try {
          let hostname = window.location.hostname === '127.0.0.1' ? window.location.hostname + ':8000' : window.location.hostname;
          const url = "{{protocol}}://" + hostname + "/milkbasket/api/v1/accounts/{{ register_date_year }}/{{ register_date_month }}/";
          const response = await fetch(url);
          const data = await response.json();
          this.setState({expenses: data.expenses})
          this.setState({income: data.income})
          this.setState({paid_customers: data.paid_customers})
          this.setState({due_customers: data.due_customers})
          this.setState({previous_month_name: data.previous_month_name})
          this.setState({is_loading: false})
        } catch (e) {
          this.setState({is_error: 'Something went wrong, please try again later. ' + e})
          this.setState({is_loading: false})
        }
      }


      render() {
        const loadingComp = <div className="text-center m-xl-5 p-xl-5">
          <div className="spinner-grow text-primary spinner-size-big" role="status">
            <span className="sr-only">Loading...</span>
          </div>
          <div className="spinner-grow text-secondary spinner-size-big" role="status">
            <span className="sr-only">Loading...</span>
          </div>
          <div className="spinner-grow text-success spinner-size-big" role="status">
            <span className="sr-only">Loading...</span>
          </div>
          <div className="spinner-grow text-danger spinner-size-big" role="status">
            <span className="sr-only">Loading...</span>
          </div>
          <div className="spinner-grow text-warning spinner-size-big" role="status">
            <span className="sr-only">Loading...</span>
          </div>
          <div className="spinner-grow text-info spinner-size-big" role="status">
            <span className="sr-only">Loading...</span>
          </div>
          <div className="spinner-grow text-dark spinner-size-big" role="status">
            <span className="sr-only">Loading...</span>
          </div>
        </div>

        return (
          <div>
            <div className='p-0'>
              <div>
                {this.state.is_loading ? loadingComp
                  : (
                    <div>

                      {!this.state.expenses.length && !this.state.income.length && !this.state.paid_customers.length && !this.state.due_customers.length ?
                        <div className="alert alert-primary text-center" role="alert">
                          Nothing to display at the moment
                        </div>
                        : ''}

                      {this.state.is_error ?
                        <div className="alert alert-danger text-center" role="alert">
                          {this.state.is_error}
                        </div> : ''}

                      {# Due Customers #}
                      {this.state.due_customers.length ? (
                        <DueCustomers entry={this.state.due_customers} title="Due Customers"
                                      previous_month_name={this.state.previous_month_name}/>
                      ) : ''}

                      {# Paid Customers #}
                      {this.state.paid_customers.length ? (
                        <PaidCustomers entry={this.state.paid_customers} title="Paid Customers"/>
                      ) : ''}

                      {# Expense Table #}
                      {this.state.expenses.length ? (
                        <IncomeExpense entry={this.state.expenses} title="Expenses"/>
                      ) : ''}

                      {# Income Table #}
                      {this.state.income.length ? (
                        <IncomeExpense entry={this.state.income} title="Income"/>
                      ) : ''}
                      <p className="text-center mb-5 text-secondary"> --- END OF PAGE ---</p>
                    </div>

                  )}
              </div>
            </div>
          </div>


        );
      }
    }

    ReactDOM.render(
      <Accounts/>
      , document.getElementById("report"));

  </script>


  {#  React Component ends here #}

  {#  Add expense Modal #}
  <div class="modal fade" id="exampleModal1" tabindex="-1" role="dialog"
       aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Add New Expense - {{ month_year }}</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form name="addexp" action="{% url 'manage_expense' %}" method="post">{% csrf_token %}
          <input type="hidden" class="form-control" id="modal_id" name="month_year"
                 value="{{ month_year }}">

          <div class="p-4">
            <div class="form-row">
              <div class="form-group col-md-12">
                <label for="modal_desc">Description</label>
                <textarea id="modal_desc" class="form-control"
                          placeholder="Narration of the expense" name="exp_desc"
                          rows="4" cols="50"></textarea>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-12">
                <label for="name">Cost</label>
                <input autofocus type="number" step="0.01" class="form-control" id="exp_cost"
                       name="cost_amount"
                       placeholder="Amount">
              </div>
            </div>

            <button onclick="submitFormFn(this);" type="submit"
                    class="btn btn-primary justify-content-center">Add Expense
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>


  {#  Add income Modal #}
  <div class="modal fade" id="addIncomeModal" tabindex="-1" role="dialog"
       aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Add New Income - {{ month_year }}</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form name="addexp" action="{% url 'manage_income' %}" method="post">{% csrf_token %}
          <input type="hidden" class="form-control" id="modal_id" name="month_year"
                 value="{{ month_year }}">
          <div class="p-4">
            <div class="form-row">
              <div class="form-group col-md-12">
                <label for="modal_desc">Description</label>
                <textarea id="modal_desc" class="form-control"
                          placeholder="Narration of the Income" name="exp_desc"
                          rows="4" cols="50"></textarea>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group col-md-12">
                <label for="name">Amount</label>
                <input autofocus type="number" step="0.01" class="form-control" id="exp_cost"
                       name="income_amount"
                       placeholder="Amount">
              </div>
            </div>
            <button onclick="submitFormFn(this);" type="submit"
                    class="btn btn-primary justify-content-center">Add Income
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

{% endblock %}
{% include "register/footer.html" %}
